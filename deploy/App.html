<!DOCTYPE html>
<html>
<head>
    <title>StoryReleaseTrackingByFeature</title>

    <script type="text/javascript" src="/apps/2.1/sdk.js"></script>

    <script type="text/javascript">
        Rally.onReady(function () {
                Ext.define("ReleaseColumn",{extend:"Rally.ui.cardboard.Column",alias:"widget.releasecolumn",plugins:["rallycardboardcollapsiblecolumns"],constructor:function(e){this.mergeConfig(e),this.config=Ext.merge({columnHeaderConfig:{record:this._getTimeboxRecord(),fieldToDisplay:"Name",editable:!1}},this.config),this.config.value=Rally.util.Ref.getRelativeUri(this._getTimeboxRecord()),this.callParent([this.config])},getStoreFilter:function(){return null===this._getTimeboxRecord()?this.callParent(arguments):[{property:"Release.Name",value:this._getTimeboxRecord().get("Name")},{property:"Release.ReleaseStartDate",value:Rally.util.DateTime.toIsoString(this._getTimeboxRecord().get("ReleaseStartDate"))},{property:"Release.ReleaseDate",value:Rally.util.DateTime.toIsoString(this._getTimeboxRecord().get("ReleaseDate"))}]},afterRender:function(){this.callParent(arguments);var e="planning-column";_.invoke(this.getContentCellContainers(),"addCls",e),this.getColumnHeaderCell().addCls(e)},isMatchingRecord:function(e){if(this._getTimeboxRecord()){var t=this.releases[0].raw,a=e.get("Release");return t.ReleaseStartDate===a.ReleaseStartDate&&t.ReleaseDate===a.ReleaseDate&&t.Name===a.Name}return null===e.raw.Release&&null===this._getTimeboxRecord()},drawHeader:function(){this.callParent(arguments),this._getTimeboxRecord()?this._addTimeboxDates():this.getColumnHeader().add({xtype:"component",html:"Unscheduled"})},_addTimeboxDates:function(){this.getColumnHeader().add({xtype:"component",html:this.getTimeboxDatesTpl().apply(this.getTimeboxDatesTplData())})},getTimeboxDatesTpl:function(){return this.timeboxDatesTpl=this.timeboxDatesTpl||Ext.create("Ext.XTemplate",'<div class="timeboxDates">{formattedStartDate} - {formattedEndDate}</div>'),this.timeboxDatesTpl},getTimeboxDatesTplData:function(){return{formattedStartDate:this._getFormattedDate("ReleaseStartDate"),formattedEndDate:this._getFormattedDate("ReleaseDate")}},_getFormattedDate:function(e){return Rally.util.DateTime.formatDate(this._getTimeboxRecord().get(e),!1)},_getTimeboxRecord:function(){return this.releases[0]},_getTimeboxScope:function(){return Ext.create("Rally.app.TimeboxScope",{record:this._getTimeboxRecord(),type:"release"})}});
                Ext.define("Rally.ui.cardboard.plugin.CollapsibleColumnsFix",{override:"Rally.ui.cardboard.plugin.CollapsibleColumns",_toggleDnDPlugin:function(l){var n=this.column.dropControllerPlugin;n&&(l?n.enable():n.disable())},_collapseExpandSuccess:function(l){this.cardboard.fireEvent("headersizechanged",this),this.cardboard.fireEvent("columnvisibilitychanged",this),l?(this.expandButton.show(),this._toggleDnDPlugin(!1),Ext.defer(function(){_.invoke(this.column.getContentCellContainers(),"on","click",this._onColumnClick,this),this.column.getColumnHeaderCell().on("click",this._onColumnClick,this)},1,this)):(this.collapseButton.show(),_.invoke(this.column.getContentCells(),"show"),this._toggleDnDPlugin(!0),this._setClassesForCollapseState(!1),_.invoke(this.column.getContentCellContainers(),"un","click",this._onColumnClick,this),this.column.getColumnHeaderCell().un("click",this._onColumnClick,this))}});
                var LOWEST_LEVEL_PI_NAME="Feature";Ext.define("CustomApp",{extend:"Rally.app.App",componentCls:"app",requires:["ReleaseColumn"],getSettingsFields:function(){return[{type:"query"}]},launch:function(){var e=this.getContext();Ext.create("Rally.data.wsapi.Store",{model:"Release",context:e.getDataContext(),filters:[{property:"ReleaseDate",operator:">=",value:"today"}],sorters:[{propety:"ReleaseStartDate",direction:"ASC"}],fetch:["Name","ReleaseStartDate","ReleaseDate"],pageSize:2e3,limit:1/0}).load().then({success:this._onReleasesLoaded,scope:this})},_onReleasesLoaded:function(e){var t=_.groupBy(e,function(e){return e.get("Name")+"-"+Rally.util.DateTime.formatDate(e.get("ReleaseStartDate"))+"-"+Rally.util.DateTime.formatDate(e.get("ReleaseDate"))}),a=["hierarchicalrequirement"],r=this.getContext(),i=_.sortBy(_.map(t,function(e){return{xtype:"releasecolumn",releases:e}}),function(e){return e.releases[0].get("ReleaseStartDate")});i.push({xtype:"releasecolumn",releases:[null]}),this.down("rallygridboard")&&this.down("rallygridboard").destroy();var l=["Milestones","Tags"];this.add({xtype:"rallygridboard",context:r,modelNames:a,toggleState:"board",stateful:!1,plugins:[{ptype:"rallygridboardinlinefiltercontrol",inlineFilterButtonConfig:{stateful:!0,stateId:r.getScopedStateId("filters"),modelNames:a,inlineFilterPanelConfig:{quickFilterPanelConfig:{defaultFields:["ArtifactSearch"],addQuickFilterConfig:{whiteListFields:l}},advancedFilterPanelConfig:{advancedFilterRowsConfig:{propertyFieldConfig:{whiteListFields:l}}}}}},{ptype:"rallygridboardfieldpicker",headerPosition:"left",modelNames:a,stateful:!0,stateId:r.getScopedStateId("columns-example"),boardAlwaysSelectedValues:["ScheduleState"]},{ptype:"rallygridboardactionsmenu",menuItems:[{text:"Print...",handler:function(){this.down("rallygridboard").getGridOrBoard().openPrintPage({title:"Program Board"})},scope:this}],buttonConfig:{iconCls:"icon-export"}}],cardBoardConfig:{plugins:[{ptype:"rallyfixedheadercardboard"},{ptype:"rallycardboardprinting"}],readOnly:!0,rowConfig:{field:LOWEST_LEVEL_PI_NAME,sorters:[{property:LOWEST_LEVEL_PI_NAME+"."+this._getRankField(),direction:"ASC"},{property:this._getRankField(),direction:"ASC"}],sortField:this._getRankField()},columns:i,attribute:"Release",columnConfig:{fields:["ScheduleState"]}},storeConfig:{fetch:["Release","Name","ReleaseStartDate","ReleaseDate"],filters:this._getFilters()}})},_getFilters:function(){var e=[];return this.getSetting("query")&&e.push(Rally.data.QueryFilter.fromQueryString(this.getSetting("query"))),e},_getRankField:function(){return this.getContext().getWorkspace().WorkspaceConfiguration.DragDropRankingEnabled?Rally.data.Ranker.RANK_FIELDS.DND:Rally.data.Ranker.RANK_FIELDS.MANUAL}});

            Rally.launchApp('CustomApp', {
                name:"StoryReleaseTrackingByFeature",
                parentRepos:"",
                version:"0.1.3"
            });

        });
    </script>


    <style type="text/css">
        
    </style>
</head>
<body>
</body>
</html>
